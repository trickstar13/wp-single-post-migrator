# WP Single Post Migrator

WordPress記事を画像ファイルと共にZIP形式で完全にエクスポート・インポートできる包括的な移行ツール。

## 主な機能

### 🚀 エクスポート機能

- WordPress記事（カスタム投稿タイプ含む）をXML形式でエクスポート
- ブロック内とメタフィールド内の画像を自動検出・収集
- XMLと画像ファイルを1つのZIPファイルに統合
- WordPress WXR（eXtended RSS）形式をサポート
- 画像とメタフィールドの包含/除外を選択可能

### 📥 インポート機能

- XMLと画像を含むZIPファイルから記事をインポート
- 現在の記事内容を新しいデータで置き換え
- インポートした画像のURLを自動的に新環境に対応
- ACFやカスタムフィールドのデータも完全復元
- WordPress WXR形式とシンプルXML形式の両方に対応

### 🔄 同期パターンエクスポート・インポート機能

- サイト全体の同期パターン（Synced Patterns / 再利用ブロック）を管理
- 同期パターンをJSON形式でエクスポート・インポート
- パターン内の画像も自動的に収集・移行
- WordPress 6.3以降の新しい同期パターンシステムをサポート
- 既存パターンの置換または新規作成を選択可能

### 🖼️ 画像のみインポート機能（従来機能）

- 複数の画像をZIPファイルで一括アップロード
- ファイル名に基づいて画像ブロックを自動更新
- LazyBlocksカスタムブロックをサポート
- ACFやカスタムフィールドの画像データも自動更新
- ブロックエディタエラーを防ぐ安全なJSONエンコーディング

### 🏷️ タクソノミーサポート

- カテゴリ、タグ、カスタムタクソノミーのエクスポート・インポート
- WordPress WXR標準形式に完全対応
- 安全な処理：存在しないタクソノミーは自動的にスキップ
- 既存のタームは再利用、新しいタームは必要に応じて作成

## 対応コンテンツ

### ブロックタイプ

- 画像ブロック (`core/image`)
- ギャラリーブロック (`core/gallery`)
- LazyBlocksカスタムブロック (`lazyblock/*`)
- 同期パターン (WordPress 6.3+の`wp_block`投稿タイプ)

### ファイル形式

- **画像**: JPG, JPEG, PNG, GIF, WebP, SVG
- **データ**: WordPress WXR形式、シンプルXML形式

### メタフィールド

- Advanced Custom Fields (ACF)
- カスタム投稿メタフィールド
- JSON形式の画像データ
- ネストしたデータ構造

## インストール

1. プラグインファイルを `/wp-content/plugins/wp-single-post-migrator/` ディレクトリにアップロード
2. WordPress管理画面でプラグインを有効化
3. 記事編集画面のサイドバーに「Import/Export Post with Media」メタボックスが表示されます
4. 同期パターンのエクスポート/インポートは独立したセクションとして利用可能

## 使用方法

### エクスポート手順

1. エクスポートしたい記事の編集画面を開く
2. サイドバーの「エクスポート」セクションでオプションを選択
3. 「記事をエクスポート」ボタンをクリック
4. 生成されたZIPファイルをダウンロード

### インポート手順

1. インポート先の記事編集画面を開く
2. サイドバーの「インポート」セクションでZIPファイルを選択
3. 「記事をインポート」ボタンをクリック（現在の記事内容が置き換えられます）
4. 確認ダイアログで置き換えを承認

### 同期パターンエクスポート手順

1. 任意の記事編集画面を開く
2. サイドバーの「同期パターン」セクションで「同期パターンをエクスポート」ボタンをクリック
3. 生成されたZIPファイルをダウンロード

### 同期パターンインポート手順

1. 任意の記事編集画面を開く
2. サイドバーの「同期パターン」セクションでZIPファイルを選択
3. 「同期パターンをインポート」ボタンをクリック
4. インポート設定に従って既存パターンの置換または新規作成を実行

### 画像のみインポート手順（従来機能）

1. 対象記事の編集画面を開く
2. サイドバーの「画像のみインポート」セクションでZIPファイルを選択
3. 「画像のみインポート」ボタンをクリック

## システム要件

- WordPress 5.9以上（ブロックエディタ必須）
- PHP 7.4以上
- PHP ZipArchive拡張モジュール

## 使用場面

- **環境間移行**: ローカル環境からステージング・本番環境への記事移行
- **バックアップ・復元**: 重要な記事のバックアップとリストア
- **コンテンツ移植**: 異なるWordPressサイト間でのコンテンツ移植
- **開発環境同期**: 開発環境でのコンテンツ同期とテストデータ作成
- **メディア一括管理**: 大量の画像を含む記事のバッチ処理
- **同期パターン管理**: サイト間での再利用ブロック・パターンの移行・共有

## 技術仕様

### アーキテクチャ

- エクスポート、インポート、ZIP処理、メディア管理、同期パターン処理を独立したクラスで実装
- WordPress WXR標準に完全準拠
- DOMDocumentを使用した安全なXML処理
- WordPress標準のメディアライブラリAPIを活用
- 同期パターン専用ハンドラーによる効率的なパターン管理

### セキュリティ

- 適切な権限チェック（投稿編集権限の確認）
- Nonce検証（CSRF攻撃防止）
- ファイルタイプ検証（ZIPおよび画像ファイルのみ許可）
- SQLインジェクション対策（準備済みステートメント使用）
- パストラバーサル攻撃防止（ファイルパス検証）
- ファイルサイズ制限（PHPおよび独自制限）

### パフォーマンス

- 一時ファイルの自動削除
- メモリ効率的なファイル処理
- 大容量ファイルの警告（10MB以上）
- 非同期処理による応答性向上
- 進捗表示によるユーザビリティ向上

## 更新履歴

### 2.1.0

- **同期パターン機能**: WordPress 6.3+の同期パターン（Synced Patterns）完全対応
- **パターンエクスポート**: サイト全体の同期パターンをJSON形式でエクスポート
- **パターンインポート**: 既存パターン置換・新規作成の選択可能インポート
- **パターン画像管理**: 同期パターン内の画像も自動収集・移行
- **独立UI**: 記事機能とは独立した同期パターン専用インターフェース

### 2.0.0

- **メジャーアップデート**: 完全なエクスポート・インポート機能を追加
- **タクソノミーサポート**: カテゴリ、タグ、カスタムタクソノミー対応
- **エクスポート機能**: WordPress WXR形式での記事データエクスポート
- **画像自動収集**: ブロックとメタフィールドから画像を自動検出・収集
- **統合インポート**: XMLデータと画像の一括インポート機能
- **記事置き換え**: 既存記事の内容を安全に置き換え
- **UI刷新**: 3つのセクションに分かれた直感的なインターフェース
- **ドラッグ&ドロップ**: ファイル選択の操作性を向上
- **自動URL書き換え**: インポート時の画像URLを自動変換
- **エラーハンドリング**: より詳細なエラー情報と回復機能
- **パフォーマンス向上**: 大容量ファイルの処理効率を改善

### 1.0.0

- 初回リリース
- 基本的なZIPインポート機能
- 画像・ギャラリーブロック対応
- LazyBlocksカスタムブロック対応
- メタフィールド（ACF等）対応
- ネストしたJSON構造の再帰的処理
- 改行文字保護機能
- JSON安全性確保（ブロックエディタエラー防止）
- 重複ファイル管理
- 進行状況表示

## ライセンス

このプラグインはGPL v2以降のライセンスの下で配布されています。

## サポート

原則としてサポートは提供していません。ご自身の判断にてご利用ください。このプラグインを利用したいかなる損害が発生しても、当方は一切責任を負いません。

## スクリーンショット

1. 記事編集画面の統合メタボックス（エクスポート・インポート・画像のみインポート・同期パターン）
2. エクスポート機能のオプション選択画面
3. インポート機能の記事置き換えモード
4. 同期パターンの独立したエクスポート・インポート機能
5. ZIPファイル選択とドラッグ&ドロップ対応
6. 処理進行状況の表示
7. 詳細な結果表示とダウンロードリンク
