# WP Single Post Migrator

WordPress記事を画像ファイルと共にZIP形式で完全にエクスポート・インポートできる包括的な移行ツール。

## 主な機能

### 🔄 エクスポート・インポート機能

- **エクスポート**: 記事・画像・メタデータを1つのZIPファイルに統合
- **インポート**: 任意のドメイン・サブディレクトリ環境間で完全移行
- **自動変換**: 画像URLとドメインを新環境に自動適応
- **完全対応**: LazyBlocks、カスタムフィールド、タクソノミー

### 🎨 同期パターン機能

- **パターン管理**: WordPress 6.3+の同期パターンを一括エクスポート・インポート
- **画像含む移行**: パターン内画像も自動収集・変換

### 🖼️ 画像のみインポート（レガシー）

- **一括更新**: ZIPから画像を一括アップロード、ファイル名で自動マッチング
- **ブロック対応**: 画像・ギャラリー・LazyBlocksを自動更新

### 🏷️ タクソノミー完全対応

- **自動処理**: カテゴリ・タグ・カスタムタクソノミーを安全に移行

## 対応範囲

**ブロック**: 画像・ギャラリー・LazyBlocks・同期パターン
**ファイル**: JPG, PNG, GIF, WebP, SVG
**データ**: カスタムフィールド・タクソノミー

## インストール

### ZIPファイルの作成

WordPressにアップロードするためのZIPファイルを作成するには、以下のコマンドを実行してください：

```bash
zip -r wp-single-post-migrator.zip . \
  -x "*.git*" \
  -x "*.DS_Store" \
  -x "CLAUDE.md" \
  -x "node_modules/*"
```

このコマンドは、プラグインの必要なファイルのみを含むZIPファイルを作成します。作成された `wp-single-post-migrator.zip` をWordPress管理画面からアップロードできます。

### プラグインのインストール

1. プラグインファイルを `/wp-content/plugins/wp-single-post-migrator/` ディレクトリにアップロード
2. WordPress管理画面でプラグインを有効化
3. 記事編集画面のサイドバーに「Import/Export Post with Media」メタボックスが表示されます
4. 同期パターンのエクスポート/インポートは独立したセクションとして利用可能

## 使用方法

### エクスポート手順

1. エクスポートしたい記事の編集画面を開く
2. サイドバーの「エクスポート」セクションでオプションを選択
3. 「記事をエクスポート」ボタンをクリック
4. 生成されたZIPファイルをダウンロード

### インポート手順

1. インポート先の記事編集画面を開く
2. サイドバーの「インポート」セクションでZIPファイルを選択
3. 「記事をインポート」ボタンをクリック（現在の記事内容が置き換えられます）
4. 確認ダイアログで置き換えを承認

### 同期パターンエクスポート手順

1. 任意の記事編集画面を開く
2. サイドバーの「同期パターン」セクションで「同期パターンをエクスポート」ボタンをクリック
3. 生成されたZIPファイルをダウンロード

### 同期パターンインポート手順

1. 任意の記事編集画面を開く
2. サイドバーの「同期パターン」セクションでZIPファイルを選択
3. 「同期パターンをインポート」ボタンをクリック
4. インポート設定に従って既存パターンの置換または新規作成を実行

### 画像のみインポート手順（従来機能）

1. 対象記事の編集画面を開く
2. サイドバーの「画像のみインポート」セクションでZIPファイルを選択
3. 「画像のみインポート」ボタンをクリック

## システム要件

- WordPress 5.9以上（ブロックエディタ必須）
- PHP 7.4以上
- PHP ZipArchive拡張モジュール

## 使用場面

**環境移行**: ローカル↔ステージング↔本番、サブディレクトリ対応
**サイト移行**: ドメイン変更、異なるWordPress間の移行
**バックアップ**: 記事・画像・設定の完全バックアップ・復元

## 技術仕様

**アーキテクチャ**: モジュラー設計、WordPress WXR準拠、依存性注入パターン
**セキュリティ**: 権限・Nonce・ファイルタイプ検証、SQLインジェクション対策
**パフォーマンス**: 自動クリーンアップ、メモリ効率化、進捗表示

## 更新履歴

### 2.4.1

- **🎯 サブディレクトリWordPress完全対応**: サブディレクトリ（例：`/blog`）にインストールされたWordPressでの画像URL処理を完全修正
- **⚡ ドメイン検出システム改良**: ハードコードされたドメインを排除し、任意のドメイン間でのマイグレーションに対応
- **🔄 共通化によるコード改善**: 同期ブロックと通常ブロックで統一されたURL処理ロジックを実装
- **🛠️ 投稿フィールド完全更新**: `direct_post_update()`で全てのサニタイズされたフィールド（post_type、comment_status、ping_status、menu_order等）を確実に更新
- **🔒 堅牢性向上**: 依存性注入パターンとクラス存在確認により、致命的エラーを防止
- **📊 エラーハンドリング強化**: より詳細で分かりやすい日本語エラーメッセージを実装
- **🏗️ アーキテクチャ改善**: クラス間の結合度を下げ、テスト容易性とメンテナンス性を向上

### 2.3.0

- **ログ機能削除**: ブロックアップデーター内の冗長なログ出力を削除し、パフォーマンスを改善

### 2.2.0

- **画像なしZIPインポート対応**: 画像が含まれていないZIPファイルでもエラーが発生しないよう改善
- **インポート時リロード修正**: 画像がないインポート時でも正常にページリロードが実行されるよう修正
- **バリデーションロジック改善**: 画像の必要性を操作種別に応じて柔軟に制御
- **エラーハンドリング強化**: 画像なしコンテンツのインポートを正常に処理

### 2.1.0

- **同期パターン機能**: WordPress 6.3+の同期パターン（Synced Patterns）完全対応
- **パターンエクスポート**: サイト全体の同期パターンをJSON形式でエクスポート
- **パターンインポート**: 既存パターン置換・新規作成の選択可能インポート
- **パターン画像管理**: 同期パターン内の画像も自動収集・移行
- **独立UI**: 記事機能とは独立した同期パターン専用インターフェース

### 2.0.0

- **メジャーアップデート**: 完全なエクスポート・インポート機能を追加
- **タクソノミーサポート**: カテゴリ、タグ、カスタムタクソノミー対応
- **エクスポート機能**: WordPress WXR形式での記事データエクスポート
- **画像自動収集**: ブロックとメタフィールドから画像を自動検出・収集
- **統合インポート**: XMLデータと画像の一括インポート機能
- **記事置き換え**: 既存記事の内容を安全に置き換え
- **UI刷新**: 3つのセクションに分かれた直感的なインターフェース
- **ドラッグ&ドロップ**: ファイル選択の操作性を向上
- **自動URL書き換え**: インポート時の画像URLを自動変換
- **エラーハンドリング**: より詳細なエラー情報と回復機能
- **パフォーマンス向上**: 大容量ファイルの処理効率を改善

### 1.0.0

- 初回リリース
- 基本的なZIPインポート機能
- 画像・ギャラリーブロック対応
- LazyBlocksカスタムブロック対応
- メタフィールド対応
- ネストしたJSON構造の再帰的処理
- 改行文字保護機能
- JSON安全性確保（ブロックエディタエラー防止）
- 重複ファイル管理
- 進行状況表示

## ライセンス

このプラグインはGPL v2以降のライセンスの下で配布されています。

## サポート

原則としてサポートは提供していません。ご自身の判断にてご利用ください。このプラグインを利用したいかなる損害が発生しても、当方は一切責任を負いません。

## スクリーンショット

1. 記事編集画面の統合メタボックス（エクスポート・インポート・画像のみインポート・同期パターン）
2. エクスポート機能のオプション選択画面
3. インポート機能の記事置き換えモード
4. 同期パターンの独立したエクスポート・インポート機能
5. ZIPファイル選択とドラッグ&ドロップ対応
6. 処理進行状況の表示
7. 詳細な結果表示とダウンロードリンク
