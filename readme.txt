=== Import/Export Post Block Media from ZIP ===
Contributors: (your-username)
Tags: media, import, export, zip, blocks, gutenberg, lazyblocks, migration, backup
Requires at least: 5.9
Tested up to: 6.4
Requires PHP: 7.4
Stable tag: 2.0.0
License: GPLv2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html

WordPress記事を画像ファイルと共にZIP形式で完全にエクスポート・インポートできる包括的な移行ツール。XML形式の記事データと関連画像を一括処理し、ローカル環境からステージング環境への効率的な記事移行を実現

== Description ==

**Import/Export Post Block Media from ZIP** は、WordPress記事の完全な移行を可能にする包括的なエクスポート・インポートプラグインです。

= 主な機能 =

## エクスポート機能
* **完全な記事エクスポート**: 記事データをXML形式（WordPress WXR）でエクスポート
* **画像自動収集**: ブロック内とメタフィールド内の画像を自動検出・収集
* **ZIPパッケージ化**: XMLと画像ファイルを1つのZIPファイルに統合
* **選択可能オプション**: 画像とメタフィールドの包含/除外を選択可能

## インポート機能
* **XML形式対応**: WordPress WXR形式とシンプルXML形式の両方に対応
* **記事置き換え**: 現在の記事内容を新しいデータで置き換え
* **自動URL書き換え**: インポートした画像のURLを自動的に新環境に対応
* **メタフィールド復元**: ACFやカスタムフィールドのデータも完全復元

## 画像のみインポート機能（従来機能）
* **ZIP一括アップロード**: 複数の画像をZIPファイルで一括アップロード
* **自動ブロック更新**: ファイル名に基づいて画像ブロックを自動更新
* **メタフィールド対応**: ACFやカスタムフィールドの画像データも自動更新
* **ネストしたJSON対応**: 複雑な構造の画像データも再帰的に処理
* **JSON安全性確保**: ブロックエディタエラーを防ぐ安全なJSONエンコーディング
* **重複管理**: 既存ファイルとの重複を自動処理
* **サブフォルダ対応**: ZIP内のサブフォルダも自動認識
* **複数形式対応**: JPG, PNG, GIF, WebP, SVG に対応

= 使用場面 =

* **環境間移行**: ローカル環境からステージング・本番環境への記事移行
* **バックアップ・復元**: 重要な記事のバックアップとリストア
* **コンテンツ移植**: 異なるWordPressサイト間でのコンテンツ移植
* **開発環境同期**: 開発環境でのコンテンツ同期とテストデータ作成
* **メディア一括管理**: 大量の画像を含む記事のバッチ処理

= 対応ブロック =

* 画像ブロック (core/image)
* ギャラリーブロック (core/gallery)
* LazyBlocksカスタムブロック (lazyblock/*)
* ACFフィールド（画像、ギャラリー、リピーターフィールド内の画像）
* その他プラグインのメタフィールド（JSON形式の画像データ）

= システム要件 =

* WordPress 5.9以上（ブロックエディタ必須）
* PHP 7.4以上
* PHP ZipArchive拡張モジュール

== Installation ==

1. プラグインファイルを `/wp-content/plugins/import-post-block-media-from-zip/` ディレクトリにアップロード
2. WordPress管理画面でプラグインを有効化
3. 記事編集画面のサイドバーに「Import/Export Post with Media」セクションが表示されます

= 基本的な使用方法 =

## エクスポート手順
1. エクスポートしたい記事の編集画面を開く
2. サイドバーの「エクスポート」セクションでオプションを選択
3. 「記事をエクスポート」ボタンをクリック
4. 生成されたZIPファイルをダウンロード

## インポート手順
1. インポート先の記事編集画面を開く
2. サイドバーの「インポート」セクションでZIPファイルを選択
3. 「記事をインポート」ボタンをクリック（現在の記事内容が置き換えられます）

## 画像のみインポート手順（従来機能）
1. 対象記事の編集画面を開く
2. サイドバーの「画像のみインポート」セクションでZIPファイルを選択
3. 「画像のみインポート」ボタンをクリック

== Frequently Asked Questions ==

= エクスポート・インポート機能について =

= エクスポートされるデータにはどのようなものが含まれますか？ =

記事のタイトル、コンテンツ、メタデータ、投稿日時、ステータスなどのすべての投稿データがXML形式で保存されます。オプションで画像ファイルとメタフィールドデータも含めることができます。

= インポート時に記事はどのように処理されますか？ =

インポート機能は現在の記事内容を新しいデータで置き換えます。操作前に確認ダイアログが表示され、元に戻すことはできないため注意が必要です。

= エクスポートしたデータを他のWordPressサイトにインポートできますか？ =

はい。WordPress標準のWXR（eXtended RSS）形式で出力されるため、異なるWordPressサイト間での移行が可能です。

= どのファイル形式に対応していますか？ =

画像ファイル: JPG, JPEG, PNG, GIF, WebP, SVG
データファイル: WordPress WXR形式、シンプルXML形式

= ZIPファイルのサイズ制限はありますか？ =

PHPの `upload_max_filesize` 設定に従います。推奨は10MB以下です。大きなファイルの場合は警告が表示されます。

= 既存のファイルと同名の場合はどうなりますか？ =

既存ファイルに親記事が設定されていない場合は再利用し、設定済みの場合は新しいファイル名で保存されます。これにより重複を避けながら効率的にメディア管理が行われます。

= 処理に失敗した場合はどうなりますか？ =

一時ファイルは自動削除され、エラーメッセージが表示されます。記事内容は変更されず、安全性が保たれます。

= LazyBlocksプラグインに対応していますか？ =

はい。LazyBlocksで作成されたカスタムブロックの画像データ（JSON形式）も自動的に更新されます。タイトル内の改行文字も正しく保持されます。

= ACFやその他のメタフィールドに対応していますか？ =

はい。Advanced Custom Fields（ACF）やその他のプラグインで作成されたメタフィールドに保存された画像データも自動的に更新されます。JSON形式、URL-エンコードされたJSON、ネストした配列構造にも対応しています。

= ブロックエディタで "not a valid JSON response" エラーが発生することはありますか？ =

このプラグインは安全なJSONエンコーディングとHTMLサニタイゼーションを実装しているため、ブロックエディタでのJSON関連エラーを防ぎます。LazyBlocksの複雑なデータ構造も安全に処理されます。

== Screenshots ==

1. 記事編集画面の統合メタボックス（エクスポート・インポート・画像のみインポート）
2. エクスポート機能のオプション選択画面
3. インポート機能のモード選択画面
4. ZIPファイル選択とドラッグ&ドロップ対応
5. 処理進行状況の表示
6. 詳細な結果表示とダウンロードリンク

== Changelog ==

= 2.0.0 =
* **メジャーアップデート**: 完全なエクスポート・インポート機能を追加
* **エクスポート機能**: WordPress WXR形式での記事データエクスポート
* **画像自動収集**: ブロックとメタフィールドから画像を自動検出・収集
* **統合インポート**: XMLデータと画像の一括インポート機能
* **記事置き換え**: 既存記事の内容を安全に置き換え
* **UI刷新**: 3つのセクションに分かれた直感的なインターフェース
* **ドラッグ&ドロップ**: ファイル選択の操作性を向上
* **自動URL書き換え**: インポート時の画像URLを自動変換
* **WXR対応**: WordPress標準のエクスポート形式に完全対応
* **エラーハンドリング**: より詳細なエラー情報と回復機能
* **パフォーマンス向上**: 大容量ファイルの処理効率を改善

= 1.0.0 =
* 初回リリース
* 基本的なZIPインポート機能
* 画像・ギャラリーブロック対応
* LazyBlocksカスタムブロック対応
* メタフィールド（ACF等）対応
* ネストしたJSON構造の再帰的処理
* 改行文字保護機能
* JSON安全性確保（ブロックエディタエラー防止）
* 重複ファイル管理
* 進行状況表示

== Upgrade Notice ==

= 2.0.0 =
メジャーアップデート: 完全なエクスポート・インポート機能が追加されました。従来の画像のみインポート機能も引き続きご利用いただけます。WordPress記事の完全な移行が可能になります。インポート機能は記事の置き換えに特化し、より安全で確実な移行を実現します。

= 1.0.0 =
初回リリースです。

== Technical Details ==

= アーキテクチャ =

* **モジュラー設計**: エクスポート、インポート、ZIP処理、メディア管理を独立したクラスで実装
* **WordPress WXR準拠**: WordPress標準のエクスポート形式に完全対応
* **XML処理**: DOMDocumentを使用した安全なXML生成・解析
* **メディア統合**: WordPress標準のメディアライブラリAPIを活用

= セキュリティ =

* 適切な権限チェック（投稿編集権限の確認）
* Nonce検証（CSRF攻撃防止）
* ファイルタイプ検証（ZIPおよび画像ファイルのみ許可）
* SQLインジェクション対策（準備済みステートメント使用）
* パストラバーサル攻撃防止（ファイルパス検証）
* ファイルサイズ制限（PHPおよび独自制限）

= パフォーマンス =

* 一時ファイルの自動削除
* メモリ効率的なファイル処理
* 大容量ファイルの警告
* 非同期処理による応答性向上
* 進捗表示によるユーザビリティ向上

= 開発者向け =

* **エクスポート機能**:
  - WXRおよびシンプルXML形式対応
  - 再帰的な画像収集アルゴリズム
  - メタフィールドデータの完全保持
* **インポート機能**:
  - XML解析とデータ復元
  - 画像URLの自動書き換え
  - 投稿作成・更新の選択機能
* **画像処理**:
  - LazyBlocksプラグイン完全対応
  - メタフィールド（ACF、カスタムフィールド）対応
  - JSON形式画像データの解析・更新
  - 再帰的なネストデータ処理
  - 安全なJSONエンコーディング
  - 改行文字保護機能
  - HTMLサニタイゼーション
* **ログとデバッグ**:
  - 詳細なログ出力（WP_DEBUG対応）
  - 包括的なエラーハンドリング
  - デバッグ用のブロック解析エンドポイント

== Support ==

サポートが必要な場合は、GitHubリポジトリでIssueを作成してください。

== License ==

このプラグインはGPLv2以降のライセンスの下で配布されています。